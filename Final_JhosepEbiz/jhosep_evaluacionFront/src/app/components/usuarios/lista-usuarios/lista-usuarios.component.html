<div class="container mt-4">
  <div class="row">
    <div class="col-12">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>GestiÃ³n de Usuarios</h2>
        <button class="btn btn-primary" routerLink="/register">
          Nuevo Usuario
        </button>
      </div>
    </div>
  </div>

  <div class="row">
    <div class="col-12">
      <div class="card">
        <div class="card-body">
          <!-- Filtros -->
          <div class="row mb-3">
            <div class="col-md-4">
              <label for="filtroRol" class="form-label">Filtrar por Rol</label>
              <select class="form-select" id="filtroRol" [(ngModel)]="filtroRol" (change)="aplicarFiltros()">
                <option value="">Todos los roles</option>
                <option value="ADMIN">Administrador</option>
                <option value="EVALUADOR">Evaluador</option>
                <option value="EMPLEADO">Empleado</option>
              </select>
            </div>
            <div class="col-md-4">
              <label for="buscar" class="form-label">Buscar</label>
              <input 
                type="text" 
                class="form-control" 
                id="buscar" 
                placeholder="Buscar por nombre o email..."
                [(ngModel)]="textoBusqueda"
                (input)="aplicarFiltros()">
            </div>
            <div class="col-md-4 d-flex align-items-end">
              <button class="btn btn-outline-secondary" (click)="limpiarFiltros()">
                Limpiar Filtros
              </button>
            </div>
          </div>

          <div class="table-responsive">
            <table class="table table-hover">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Nombre Completo</th>
                  <th>Email</th>
                  <th>Rol</th>
                  <th>Cargo</th>
                  <th>Fecha Registro</th>
                  <th>Evaluaciones</th>
                  <th>Acciones</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let usuario of usuariosFiltrados">
                  <td>{{usuario.id}}</td>
                  <td>{{usuario.nombre}} {{usuario.apellido}}</td>
                  <td>{{usuario.email}}</td>
                  <td>
                    <span class="badge"
                          [class.bg-danger]="usuario.rol === 'ADMIN'"
                          [class.bg-warning]="usuario.rol === 'EVALUADOR'"
                          [class.bg-info]="usuario.rol === 'EMPLEADO'">
                      {{usuario.rol | rolUsuario}}
                    </span>
                  </td>
                  <td>{{usuario.cargo || 'N/A'}}</td>
                  <td>{{usuario.fechaCreacion | date:'short'}}</td>
                  <td>
                    <span class="badge bg-secondary">{{contarEvaluaciones(usuario.id)}}</span>
                  </td>
                  <td>
                    <div class="btn-group btn-group-sm">
                      <button 
                        class="btn btn-outline-info"
                        (click)="verDetalle(usuario)">
                        Ver
                      </button>
                      <button 
                        class="btn btn-outline-info btn-sm"
                        (click)="verEvaluacionesUsuario(usuario)">
                        ðŸ“Š Ver Evaluaciones
                      </button>
                      <button 
                        class="btn btn-outline-danger"
                        (click)="eliminar(usuario.id)"
                        [disabled]="usuario.id === currentUser?.id">
                        Eliminar
                      </button>
                    </div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>

          <div *ngIf="usuariosFiltrados.length === 0" class="text-center text-muted py-4">
            No se encontraron usuarios
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal detalle usuario -->
<div class="modal fade" id="detalleUsuarioModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Detalle del Usuario</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" *ngIf="usuarioSeleccionado">
        <div class="row">
          <div class="col-md-6">
            <h6>InformaciÃ³n Personal</h6>
            <p><strong>Nombre:</strong> {{usuarioSeleccionado.nombre}} {{usuarioSeleccionado.apellido}}</p>
            <p><strong>Email:</strong> {{usuarioSeleccionado.email}}</p>
            <p><strong>Cargo:</strong> {{usuarioSeleccionado.cargo || 'N/A'}}</p>
            <p><strong>Rol:</strong> 
              <span class="badge"
                    [class.bg-danger]="usuarioSeleccionado.rol === 'ADMIN'"
                    [class.bg-warning]="usuarioSeleccionado.rol === 'EVALUADOR'"
                    [class.bg-info]="usuarioSeleccionado.rol === 'EMPLEADO'">
                {{usuarioSeleccionado.rol | rolUsuario}}
              </span>
            </p>
            <p><strong>Fecha de Registro:</strong> {{usuarioSeleccionado.fechaCreacion | date:'fullDate'}}</p>
          </div>
          <div class="col-md-6">
            <h6>EstadÃ­sticas de Evaluaciones</h6>
            <div class="row text-center">
              <div class="col-6">
                <h4 class="text-primary">{{contarEvaluacionesRecibidas(usuarioSeleccionado.id)}}</h4>
                <small>Evaluaciones Recibidas</small>
              </div>
              <div class="col-6">
                <h4 class="text-success">{{contarEvaluacionesRealizadas(usuarioSeleccionado.id)}}</h4>
                <small>Evaluaciones Realizadas</small>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
      </div>
    </div>
  </div>
</div>
<!-- Modal para ver evaluaciones del usuario -->
<div class="modal fade" id="evaluacionesUsuarioModal" tabindex="-1">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" *ngIf="usuarioSeleccionado">
          ðŸ“Š Evaluaciones de {{usuarioSeleccionado.nombre}} {{usuarioSeleccionado.apellido}}
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div *ngIf="evaluacionesUsuario.length === 0" class="text-center text-muted py-4">
          Este usuario no tiene evaluaciones registradas
        </div>
        
        <div *ngIf="evaluacionesUsuario.length > 0" class="table-responsive">
          <table class="table table-hover">
            <thead>
              <tr>
                <th class="text-center">ID</th>
                <th class="text-center">Ciclo</th>
                <th class="text-center">Tipo</th>
                <th class="text-center">Estado</th>
                <th class="text-center">PuntuaciÃ³n</th>
                <th class="text-center">Fecha</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let evaluacion of evaluacionesUsuario">
                <td class="text-center">{{evaluacion.id}}</td>
                <td class="text-center">{{evaluacion.ciclo.nombre}}</td>
                <td class="text-center">{{evaluacion.tipo}}</td>
                <td class="text-center">
                  <span class="badge" 
                        [class.bg-warning]="evaluacion.estado === 'PENDIENTE'"
                        [class.bg-success]="evaluacion.estado === 'COMPLETADA'"
                        [class.bg-primary]="evaluacion.estado === 'FIRMADA'">
                    {{evaluacion.estado | estadoEvaluacion}}
                  </span>
                </td>
                <td class="text-center">{{evaluacion.puntuacionFinal || 'N/A'}}</td>
                <td class="text-center">{{evaluacion.fechaCreacion | date:'short'}}</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
      </div>
    </div>
  </div>
</div>